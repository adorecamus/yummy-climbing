<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper
	namespace="com.yummyclimbing.mapper.party.PartyInfoMapper">

	<sql id="partyInfoCols">
		PI_NAME, PI_EXPDAT, PI_MEETING_TIME, 
		PI_MEMBER_CNT, PI_PROFILE, PI_CREDAT, PI_COMPLETE
	</sql>
	
	<sql id="partyTableJoin">
		PARTY_INFO PI
		INNER JOIN MOUNTAIN_INFO MI ON PI.MI_NUM = MI.MI_NUM
		INNER JOIN PARTY_MEMBER PM ON PI.PI_NUM = PM.PI_NUM AND PM_ACTIVE = 1
	</sql>

	<!-- 소모임 리스트, 정렬, 검색 -->
	<select id="selectPartyInfoList"
		resultType="com.yummyclimbing.vo.party.PartyInfoVO">
		SELECT P_VIEW.PI_NUM, MNTNM, MEM_NUM, COUNT(PUL.UI_NUM) LIKE_NUM,
		<include refid="partyInfoCols"></include>
		FROM
		(SELECT PI.PI_NUM, COUNT(PM.UI_NUM) MEM_NUM, MNTNM,
		<include refid="partyInfoCols"></include>
		FROM
		<include refid="partyTableJoin"></include>
		WHERE PI_ACTIVE = 1
		AND PI_COMPLETE IN(0
		<if test='includeComplete == true'>
			, 1
		</if>
		)
		GROUP BY PI.PI_NUM) P_VIEW
		LEFT OUTER JOIN PARTY_USER_LIKE PUL ON P_VIEW.PI_NUM = PUL.PI_NUM
		<where>
			<if test='searchText != null and searchText != ""'>
				AND ${searchType} LIKE CONCAT('%', #{searchText}, '%')
			</if>
		</where>
		GROUP BY PUL.PI_NUM
		ORDER BY ${sortType} ${sortOrder}
	</select>

	<!-- 개별 소모임 보기 -->
	<select id="selectPartyInfo"
		resultType="com.yummyclimbing.vo.party.PartyInfoVO">
		SELECT P_VIEW.PI_NUM, MNTNM, MEM_NUM, COUNT(PUL.UI_NUM) LIKE_NUM,
		<include refid="partyInfoCols"></include>
		,UI.UI_NICKNAME
		FROM
		(SELECT PI.PI_NUM, COUNT(PM.UI_NUM) MEM_NUM, PI.UI_NUM, MNTNM,
		<include refid="partyInfoCols"></include>
		FROM
		<include refid="partyTableJoin"></include> 
		WHERE PI.PI_NUM = #{piNum}) P_VIEW
		LEFT OUTER JOIN PARTY_USER_LIKE PUL ON P_VIEW.PI_NUM = PUL.PI_NUM
		INNER JOIN USER_INFO UI ON P_VIEW.UI_NUM = UI.UI_NUM
	</select>

	<!-- 소모임 멤버 정보 -->
	<select id="selectPartyMemberList"
		resultType="com.yummyclimbing.vo.user.UserInfoVO">
		SELECT UI_IMG_PATH, UI_NICKNAME, UI_AGE, UI_GENDER
		FROM PARTY_INFO PI
		INNER JOIN PARTY_MEMBER PM ON PI.PI_NUM = PM.PI_NUM AND PM_ACTIVE = 1
		INNER JOIN USER_INFO UI ON PM.UI_NUM = UI.UI_NUM AND UI_ACTIVE = 1
		WHERE PI.PI_NUM = #{piNum}
	</select>

	<!-- 방장 여부 조회 -->
	<select id="selectCaptainNum"
		resultType="com.yummyclimbing.vo.party.PartyInfoVO">
		SELECT UI_NUM
		FROM PARTY_INFO
		WHERE UI_NUM = #{loginUiNum} AND PI_NUM = #{piNum}
	</select>

	<!-- 소모임 생성 -->
	<insert id="insertPartyInfo">
		INSERT INTO PARTY_INFO
		(
		<include refid="partyInfoCols"></include>
		MI_NUM, UI_NUM
		)
		VALUES(
		#{piName}, #{piExpdat}, #{piMeetingTime},
		#{piMemberCnt}, #{piProfile},
		#{miNum}, #{uiNum}
		)
	</insert>

	<!-- 소모임 수정 -->
	<update id="updatePartyInfo">
		UPDATE PARTY_INFO
		SET
		PI_NAME = #{piName},
		PI_EXPDAT = #{piExpdat},
		PI_MEETING_TIME = #{piMeetingTime},
		PI_MEMBER_CNT = #{piMemberCnt},
		PI_PROFILE = #{piProfile},
		PI_LMODAT = DATE_FORMAT(NOW(), '%Y%m%d')
		WHERE PI_NUM = #{piNum}
	</update>

	<!-- 소모임 삭제(비활성화) -->
	<update id="updatePartyActive">
		UPDATE PARTY_INFO
		SET PI_ACTIVE = 0
		WHERE PI_NUM = #{piNum}
	</update>
	
	<!-- 소모임 모집완료 -->
	<update id="updatePartyComplete">
		UPDATE PARTY_INFO
		SET PI_COMPLETE = 1
		WHERE PI_NUM = #{piNum}
	</update>
	
	<!-- 모집기한 만료 소모임 개수 -->
	<select id="selectExpiredParty" resultType="_int">
		SELECT COUNT(1) FROM PARTY_INFO
		WHERE PI_ACTIVE = 1 AND PI_EXPDAT = #{piExpdat}
	</select>
	
	<!-- 모집기한 만료 소모임 자동 완료 -->
	<update id="updatePartyCompleteByExpdat">
		UPDATE PARTY_INFO
		SET PI_COMPLETE = 1
		WHERE PI_ACTIVE = 1 AND PI_EXPDAT = #{piExpdat}
	</update>
	
	<select id="selectPiNumByMiNum" resultType="int">
		SELECT PI_NUM
		FROM PARTY_INFO PI
		INNER JOIN MOUNTAIN_INFO MI ON PI.MI_NUM = MI.MI_NUM
		WHERE PI_ACTIVE = 1 AND MI.MI_NUM = #{miNum}
	</select>

</mapper>